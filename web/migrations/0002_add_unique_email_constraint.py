# Generated by Django 5.1.4 on 2025-01-13 01:34

from django.db import migrations


class Migration(migrations.Migration):
    dependencies = [
        ("web", "0001_initial"),
    ]

    operations = [
        migrations.RunSQL(
            # Forward SQL - Add unique constraint after removing duplicates
            """
            SET @row_number = 0;
            SET @current_email = '';

            UPDATE auth_user
            JOIN (
                SELECT id,
                    email,
                    @row_number := IF(@current_email = email, @row_number + 1, 1) as rn,
                    @current_email := email
                FROM auth_user
                ORDER BY email, id
            ) as t ON auth_user.id = t.id
            SET auth_user.email = CONCAT(auth_user.email, '_', t.rn)
            WHERE t.rn > 1;

            -- Then add the unique constraint
            ALTER TABLE auth_user ADD CONSTRAINT auth_user_email_unique UNIQUE (email);
            """,
            # Reverse SQL - Remove unique constraint
            "ALTER TABLE auth_user DROP CONSTRAINT IF EXISTS auth_user_email_unique;",
        )
    ]
